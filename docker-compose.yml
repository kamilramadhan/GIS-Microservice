version: '3.8'

services:
  # ==========================================
  # API GATEWAY
  # ==========================================
  api-gateway:
    build: ./backend/api-gateway
    container_name: gis-api-gateway
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - PRICE_SERVICE_URL=http://price-service:3001
      - PRODUCTION_SERVICE_URL=http://production-service:3002
      - ANALYTICS_SERVICE_URL=http://analytics-service:3003
      - BI_SCRAPER_SERVICE_URL=http://bi-scraper-service:3005
      - ALLOWED_ORIGINS=http://localhost:8000,http://localhost:5500
    depends_on:
      - price-service
      - production-service
      - analytics-service
      - bi-scraper-service
    networks:
      - gis-network
    restart: unless-stopped

  # ==========================================
  # PRICE SERVICE
  # ==========================================
  price-service:
    build: ./backend/services/price-service
    container_name: gis-price-service
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - MONGODB_URI=mongodb://mongo:27017/gis_prices
    depends_on:
      - mongo
      - redis
    networks:
      - gis-network
    restart: unless-stopped

  # ==========================================
  # PRODUCTION SERVICE
  # ==========================================
  production-service:
    build: ./backend/services/production-service
    container_name: gis-production-service
    ports:
      - "3002:3002"
    environment:
      - PORT=3002
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/gis_production
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - postgres
      - redis
    networks:
      - gis-network
    restart: unless-stopped

  # ==========================================
  # ANALYTICS SERVICE
  # ==========================================
  analytics-service:
    build: ./backend/services/analytics-service
    container_name: gis-analytics-service
    ports:
      - "3003:3003"
    environment:
      - PORT=3003
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    depends_on:
      - redis
    networks:
      - gis-network
    restart: unless-stopped

  # BI Scraper Service
  bi-scraper-service:
    build: ./backend/services/bi-scraper-service
    container_name: gis-bi-scraper
    ports:
      - "3005:3005"
    environment:
      - PORT=3005
    networks:
      - gis-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ==========================================
  # DATABASES
  # ==========================================
  
  # MongoDB for Price Service
  mongo:
    image: mongo:7.0
    container_name: gis-mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongo-data:/data/db
    networks:
      - gis-network
    restart: unless-stopped

  # PostgreSQL for Production Service
  postgres:
    image: postgres:16-alpine
    container_name: gis-postgres
    ports:
      - "5433:5432"  # Changed to 5433 to avoid conflict with local PostgreSQL
    environment:
      - POSTGRES_DB=gis_production
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - gis-network
    restart: unless-stopped

  # Redis for Caching
  redis:
    image: redis:7-alpine
    container_name: gis-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - gis-network
    restart: unless-stopped
    command: redis-server --appendonly yes

  # ==========================================
  # MONITORING (Optional)
  # ==========================================
  
  # Nginx for Frontend
  nginx:
    image: nginx:alpine
    container_name: gis-frontend
    ports:
      - "8081:80"  # Changed to 8081 to avoid port conflict
    volumes:
      - ./frontend:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - api-gateway
    networks:
      - gis-network
    restart: unless-stopped

# ==========================================
# NETWORKS
# ==========================================
networks:
  gis-network:
    driver: bridge

# ==========================================
# VOLUMES
# ==========================================
volumes:
  mongo-data:
    driver: local
  postgres-data:
    driver: local
  redis-data:
    driver: local
